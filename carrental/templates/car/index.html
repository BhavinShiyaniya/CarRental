{% extends "base.html" %}
{% load static %}

{% block stylesheet %}
<style>
  .hero {
      height: 50vh !important;
  }
</style>
{% endblock stylesheet %}

{% block title %}CarRental - Rent Car and Enjoy! {% endblock %}

{% block content %}

<div class="hero" style="background-image: url({% static 'images/hero_1_a.jpg' %});">
        
    <div class="container">
      <div class="row align-items-center justify-content-center">
        <div class="col-lg-10">

          <div class="row mb-5">
            <div class="col-lg-7 intro">
              <h1><strong>Rent a car</strong> is within your finger tips.</h1>
            </div>
          </div>
          
          <form class="trip-form" id="searchform" method="GET">
            
            <div class="row align-items-center">
              
              <div class="mb-3 mb-md-0 col-md-3">
                <select name="car_type" id="car_type" class="custom-select form-control">
                  <option value="">Select Car Type</option>
                  <option value="SEDAN">Sedan</option>
                  <option value="HATCHBACK">Hatchback</option>
                  <option value="SUV">SUV</option>
                  <option value="COUPE">Coupe</option>
                </select>
              </div>
              <div class="mb-3 mb-md-0 col-md-3">
                {% comment %} {{myFilter.form}} {% endcomment %}
                <div class="form-control-wrap">
                  <input type="datetime-local" id="pickup_datetime" name="pickup_datetime" placeholder="Pick up" class="form-control px-3" required>
                  {% comment %} <span class="icon icon-date_range"></span> {% endcomment %}
                  {% comment %} {{myFilter.form.pickup_datetime}} {% endcomment %}
                </div>
              </div>
              
              <div class="mb-3 mb-md-0 col-md-3">
                <div class="form-control-wrap">
                  <input type="datetime-local" id="drop_datetime" name="drop_datetime" placeholder="Drop off" class="form-control datepicker px-3" required>
                  {% comment %} <span class="icon icon-date_range"></span> {% endcomment %}
                  {% comment %} {{myFilter.form.drop_datetime}} {% endcomment %}
                </div>
              </div>
              <div class="mb-3 mb-md-0 col-md-3">
                {% comment %} <input type="submit" value="Search Now" class="btn btn-primary btn-block py-3"> {% endcomment %}
                <button type="button" id="search" class="btn btn-primary btn-block py-3">Search Now</button>
              </div>
            </div>
            
          </form>

        </div>
      </div>
    </div>
  </div>



  <!-- Car Listing Results Start -->
  <div class="site-section bg-light" id="search_list">
    <div class="container">
      <div class="row">
        <div class="col-lg-7">
          <h2 class="section-heading"><strong>Car Listings</strong></h2>
          <p class="mb-5">Lorem ipsum dolor sit amet, consectetur adipisicing elit.</p>    
        </div>
      </div>
      
  
      <div class="row">
        {% if carlist %}
        {% for car in carlist|slice:":6" %}
        {% if car.is_active == True %}
        <div class="col-md-6 col-lg-4 mb-4">
  
          <div class="listing d-block  align-items-stretch">
            <div class="listing-img h-100 mr-4">
              
              <a href="{% url 'car:cardetail' pk=car.id %}"><img src="{{ car.car_image_set.all.0.car_images.url }}" alt="Image" class="img-fluid" style="height:170px;"></a>
            </div>
            <div class="listing-contents h-100">
              <a href="{% url 'car:cardetail' pk=car.id %}"><h3>{{ car.brand }} {{ car.name }} {{ car.manufacture_year }}</h3></a>
              <div class="rent-price">
                <strong>â‚¹ {{ car.fare }}</strong><span class="mx-1">/</span>hour
              </div>
              <div class="d-block d-md-flex mb-3 border-bottom pb-3">
                <div class="listing-feature pr-4">
                  <span class="caption">Fuel:</span>
                  <span class="number">{{ car.fuel_type }}</span>
                </div>
                <div class="listing-feature pr-4">
                  <span class="caption">Transmission:</span>
                  <span class="number">{{ car.transmission_type }}</span>
                </div>
                <div class="listing-feature pr-4">
                  <span class="caption">Passenger:</span>
                  <span class="number">{{ car.seats }}</span>
                </div>
              </div>
              <div>
                <p>Lorem ipsum dolor sit amet, consectetur adipisicing elit. Quos eos at eum, voluptatem quibusdam.</p>
                <p><a href="{% url 'car:cardetail' pk=car.id %}" class="btn btn-primary btn-sm">Rent Now</a></p>
              </div>
            </div>
  
          </div>
        </div>
        {% endif %}
        {% endfor %}
        {% else %}
        <div class="jumbotron w-100">
          <h1 class="text-danger text-center">Sorry, No cars available</h1>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
<!-- Car Listing Results End -->

  <div class="site-section">
    <div class="container">
      <h2 class="section-heading"><strong>How it works?</strong></h2>
      <p class="mb-5">Easy steps to get you started</p>    

      <div class="row mb-5">
        <div class="col-lg-4 mb-4 mb-lg-0">
          <div class="step">
            <span>1</span>
            <div class="step-inner">
              <span class="number text-primary">01.</span>
              <h3>Select a car</h3>
              <p>Lorem ipsum dolor sit amet, consectetur adipisicing elit. Vero, laboriosam!</p>
            </div>
          </div>
        </div>
        <div class="col-lg-4 mb-4 mb-lg-0">
          <div class="step">
            <span>2</span>
            <div class="step-inner">
              <span class="number text-primary">02.</span>
              <h3>Fill up form</h3>
              <p>Lorem ipsum dolor sit amet, consectetur adipisicing elit. Vero, laboriosam!</p>
            </div>
          </div>
        </div>
        <div class="col-lg-4 mb-4 mb-lg-0">
          <div class="step">
            <span>3</span>
            <div class="step-inner">
              <span class="number text-primary">03.</span>
              <h3>Payment</h3>
              <p>Lorem ipsum dolor sit amet, consectetur adipisicing elit. Vero, laboriosam!</p>
            </div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-lg-4 mx-auto">
          <a href="#" class="d-flex align-items-center play-now mx-auto">
            <span class="icon">
              <span class="icon-play"></span>
            </span>
            <span class="caption">Video how it works</span>
          </a>
        </div>
      </div>
    </div>
  </div>
  
  <div class="site-section">
    <div class="container">
      <div class="row align-items-center">
        <div class="col-lg-7 text-center order-lg-2">
          <div class="img-wrap-1 mb-5">
            <img src="{% static 'images/feature_01.png' %}" alt="Image" class="img-fluid">
          </div>
        </div>
        <div class="col-lg-4 ml-auto order-lg-1">
          <h3 class="mb-4 section-heading"><strong>You can easily avail our promo for renting a car.</strong></h3>
          <p class="mb-5">Lorem ipsum dolor sit amet, consectetur adipisicing elit. Repudiandae, explicabo iste a labore id est quas, doloremque veritatis! Provident odit pariatur dolorem quisquam, voluptatibus voluptates optio accusamus, vel quasi quidem!</p>
          
          <p><a href="#" class="btn btn-primary">Meet them now</a></p>
        </div>
      </div>
    </div>
  </div>



{% endblock content %}

<!-- Footer -->
{% block footer %}
{% include "footer.html" %}
{% endblock footer %}

{% block javascripts %}
<script>

  {% comment %} document.addEventListner("DOMContentLoaded", function() {
    console.log("======================");
    const pickup_datetime = document.getElementById("pickup_datetime");
    const drop_datetime = document.getElementById("drop_datetime");

    const now = new Date();
    now.setMinutes(Math.ceil(now.getMinutes() / 15) * 15);

    const maxAllowedDate = new Date();
    maxAllowedDate.setMonth(maxAllowedDate.getMonth() + 2);

    pickup_datetime.setAttribute("min", now.toISOString().slice(0, 16));

    pickup_datetime.setAttribute("max", maxAllowedDate.toISOString().slice(0, 16));

    drop_datetime.setAttribute("max", maxAllowedDate.toISOString().slice(0, 16));

    pickup_datetime.addEventListener("change", function() {
      const selectedDate = new Date(this.value);

      selectedDate.setMinutes(Math.ceil(selectedDate.getMinutes() / 15) * 15);

      drop_datetime.setAttribute("max", selectedDate.toISOString().slice(0, 16));
    });
  }); {% endcomment %}

  // Date Time Validations Start

  {% comment %} $(document).ready(function(){
    const pickup_datetime = $("#pickup_datetime")
    const drop_datetime = $("#drop_datetime")

    const now = new Date();

    now.setMinutes(Math.ceil(now.getMinutes() / 15) * 15);

    const maxAllowedDate = new Date();
    maxAllowedDate.setMonth(maxAllowedDate.getMonth() + 2);

    pickup_datetime.attr("min", now.toISOString().slice(0, 16));

    pickup_datetime.attr("max", maxAllowedDate.toISOString().slice(0, 16));
    drop_datetime.attr("max", maxAllowedDate.toISOString().slice(0, 16));

    pickup_datetime.change(function() {
      const selectedDate = new Date($(this).val());

      selectedDate.setMinutes(Math.ceil(selectedDate.getMinutes() / 15) * 15);

      drop_datetime.attr("max", selectedDate.toISOString().slice(0, 16));
    });
  }); {% endcomment %}

  // Date Time Validations End
  // =================================

  // start of date validations
  // setting min date for pickupdatetime
  var minDate = new Date().toISOString().slice(0,16);
  console.log("minDate", minDate);

  //To restrict past date
  $('#pickup_datetime').attr('min', minDate);
  $('#drop_datetime').attr('min', minDate);  
  
  // setting min date for pickupdatetime

  var currentDate = new Date();
  var nextWeekDate = new Date(currentDate.getTime() + 7 * 24 * 60 * 60 * 1000);
  var maxDate = nextWeekDate.toISOString().slice(0, 16);
  console.log("nextWeekDate", nextWeekDate);
  console.log("maxDate", maxDate);
  //To restrict future date
  $('#pickup_datetime').attr('max', maxDate);
  $('#drop_datetime').attr('max', maxDate); 

  
  // end of date validations 
  {% comment %} CurrentDate.setMonth(CurrentDate.getMonth() + x); {% endcomment %}

  //function to check startdate is not greater than end date
  {% comment %} function dateCheck(){
    var pickupdatetime = document.getElementById("pickup_datetime").value;
    var dropdatetime = document.getElementById("drop_datetime").value;

    if(pickupdatetime >= dropdatetime) {
      alert("Drop datetime need to be bigger then Pickup datetime");
    }
  } {% endcomment %}
  
  {% comment %} $("#pickup_datetime").on('change', function(){
    dateCheck();
  });

  $("#drop_datetime").on('change', function(){
    dateCheck();
  });  {% endcomment %}

  // car ajax search start
  $("#search").on("click", function(){
    console.log("+++++++++++++++++++++++++++++++++++")
    var pickupdatetime = document.getElementById("pickup_datetime").value;
    console.log(pickupdatetime)
    var dropdatetime = document.getElementById("drop_datetime").value;
    console.log(dropdatetime)
    var cartype = document.getElementById("car_type").value;
    console.log(cartype)

    // sessionStorage set data
    sessionStorage.setItem("car_type", cartype);
    sessionStorage.setItem("pickup_datetime", pickupdatetime);
    sessionStorage.setItem("drop_datetime", dropdatetime); 


    console.log("+++++++++++++++++++++++++++++++++++")

    if(pickupdatetime >= dropdatetime) {
      alert("Drop datetime need to be bigger then Pickup datetime");
      return false;
    }
    else {
      $.ajax({
        type: "GET",
        url: "{% url 'car:searchviewajax' %}",
        data: {
            "pickupdatetime": pickupdatetime,
            "dropdatetime": dropdatetime,
            "cartype": cartype,
        },
        success: function(data) {
            console.log("::",data.object_list)
            $("#search_list").html(data.object_list);
            
        }
    });
  }
  });
  // car ajax search end


  // fill form data using sessionStorage
  $(window).on('load', function() {
    // sessionStorage get data
    var car_type = sessionStorage.getItem("car_type");
    console.log("car_type: ", car_type)
    var pickup_datetime = sessionStorage.getItem("pickup_datetime");
    console.log("pickup_datetime: ", pickup_datetime)
    var drop_datetime = sessionStorage.getItem("drop_datetime");
    console.log("drop_datetime: ", drop_datetime)

    if (car_type !== null) {
      document.getElementById("car_type").value = car_type;
    }

    if (pickup_datetime !== null) {
      document.getElementById("pickup_datetime").value = pickup_datetime;
    }

    if (drop_datetime !== null) {
      document.getElementById("drop_datetime").value = drop_datetime;
    }

  });

</script>

{% endblock javascripts %}